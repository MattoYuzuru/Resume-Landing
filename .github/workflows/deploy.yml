name: Landing Deploy
run-name: ${{ github.actor }} is deploying his new CVüî•üî•üî•
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: List files
        run: ls -R

      - name: Build Docker image
        run: |
          docker build -t landing:latest ./backend

      - name: Save Docker image
        run: |
          docker save landing:latest | gzip > landing.tar.gz

      # üßπ –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
      - name: Clean remote directory
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "Cleaning old files..."
            rm -rf /home/${{ secrets.SSH_USER }}/landing/frontend
            rm -f /home/${{ secrets.SSH_USER }}/landing/docker-compose.yml
            rm -rf /home/${{ secrets.SSH_USER }}/landing/backend

      # üì§ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
      - name: Copy files to server
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: landing.tar.gz,docker-compose.yml,frontend,backend,images
          target: "/home/${{ secrets.SSH_USER }}/landing/"

      # üöÄ –î–µ–ø–ª–æ–π
      - name: Deploy on server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/${{ secrets.SSH_USER }}/landing/
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–∑
            docker load < landing.tar.gz
            
            # –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–π –∞—Ä—Ö–∏–≤
            rm landing.tar.gz
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker compose down
            docker compose up -d --build

            # –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã –∏ volume'—ã
            docker system prune -a -f --volumes
